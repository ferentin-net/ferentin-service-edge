# Docker Compose Deployment

Deploy Ferentin Service Edge using Docker Compose.

## Prerequisites

1. **Obtain an enrollment token** from the Ferentin admin console
2. Docker and Docker Compose installed

## Quick Start

```bash
# Copy environment file
cp .env.example .env

# Add your enrollment token to .env
nano .env

# Fix volume permissions (required for non-root container)
docker volume create service-edge-certs
docker volume create service-edge-policy
docker run --rm \
  -v service-edge-certs:/opt/ferentin/certs \
  -v service-edge-policy:/opt/ferentin/policy \
  alpine:latest chown -R 1000:1000 /opt/ferentin/certs /opt/ferentin/policy

# Start the service
docker-compose up -d

# Check logs
docker-compose logs -f

# Stop the service
docker-compose down
```

## Configuration

Edit `.env` file with your settings:

```bash
# Required: Enrollment token from admin console
ENROLLMENT_TOKEN=your-token-here

# Required: Enable bootstrap for first-time enrollment
BOOTSTRAP_ENABLED=true

# Required: Spring profile (determines control plane URL)
# - aws-secure: Production (https://cp.ferentin.net)
# - nginx: Local development (https://cp.local.ferentin.test)
SPRING_PROFILES_ACTIVE=aws-secure

# Optional: Image version
SERVICE_EDGE_VERSION=latest
```

## Enrollment Process

On first startup with a valid enrollment token, the service-edge:

1. **Connects** to the control plane (URL determined by Spring profile)
2. **Enrolls** using the bootstrap token
3. **Receives** edge identity (EDGE_ID, TENANT_ID, SITE_ID) - generated by control plane
4. **Obtains** mTLS certificates for secure communication
5. **Downloads** initial policy bundles

The certificates and identity are stored in persistent volumes and reused on subsequent startups.

## After Enrollment

Once enrolled, you can:
- Remove the `ENROLLMENT_TOKEN` from `.env`
- Set `BOOTSTRAP_ENABLED=false`

The edge will use the certificates stored in the persistent volume.

## Persistent Data

The following volumes are created:

| Volume | Purpose |
|--------|---------|
| `service-edge-certs` | mTLS certificates (persistent) |
| `service-edge-policy` | Policy bundles (persistent) |

Logs, data, and tmp directories use tmpfs (ephemeral).

## Health Check

```bash
# Check container health
docker-compose ps

# Manual health check
curl http://localhost:9080/actuator/health
```

## Logs

```bash
# Follow logs
docker-compose logs -f service-edge

# Last 100 lines
docker-compose logs --tail=100 service-edge
```

## Upgrade

```bash
# Pull new image
docker-compose pull

# Restart with new image
docker-compose up -d
```

## Re-enrollment

If you need to re-enroll (e.g., certificates expired):

1. Obtain a new enrollment token from admin console
2. Update `.env` with the new token
3. Set `BOOTSTRAP_ENABLED=true`
4. Optionally set `BOOTSTRAP_FORCE=true` to force re-enrollment
5. Restart: `docker-compose up -d`

## Production Configuration

For production, consider:

1. **External volumes**: Mount persistent storage for certs/policy
2. **Logging driver**: Configure log rotation or external logging
3. **Network**: Use overlay network for multi-host setups
4. **Secrets**: Use Docker secrets for the enrollment token

See `docker-compose.prod.yml` for production overrides.
